---
title: "Metabolomic Analysis"
author: "Emily Bean"
date: "January 10, 2020"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE, collapse = TRUE}
knitr::opts_chunk$set(echo = TRUE)
```
## Overview

This is the preliminary data analysis for the 15-02 metabolomics dataset, Dr. Connie Rogers lab. 

### General cleaning steps 
1. Download archived raw .wiff files from Metabolomics Core  
2. Convert .wiff to .mzML in ProteoWizard 4.0 (MS Convert)  
3. Peak picking and alignment in MSDIAL (MoNA database for hydrophilic; LipidBlast for lipids)  
4. Tidy in Excel  
5. Upload to MetaboAnalyst; quantile normalization, Pareto scaling, and log transformation  
6. Download normalized data for statistical analysis in R  

### Analysis Steps  
1. Individual metabolites 
2. Sample clustering    
3. Metabolic "community"    

### Pairwise comparisons  
*All comparisons made for tumor and plasma tissues*  
1. Plasma D7 vs D21 vd D35  
2. 4 treatment groups (2x2 factorial)  
3. Exercise vs sedentary  
4. Weight gain vs weight maintenance  
**Note:** These are _annotated metabolites only_. In the raw dataset are many tens of thousands more metabolites and lipids that were detected as compounds but not annotated; we can do a community analysis on these later if we want to.

```{r echo = FALSE}
## Read in all data and load packages
require(dplyr)
require(tidyr)
require(vegan)
require(ggplot2)
require(pairwiseAdonis)
require(ggordiplots)

# read all aqueous data
aq <- read.table("https://raw.githubusercontent.com/EmilyB17/mice-metab/master/data/allAqueousCleaned.txt", header = TRUE, stringsAsFactors = TRUE)
```

## Plasma D7 vs D21 v D35

It's important for downstream analysis to first determine if the plasma metabolome change significantly from day 7, to day 21, to day 35. If there are differences, we will need to keep the days separate for downstream analyses; if not, we can likely lump them all together.  

An ANOVA on each individual metabolite by Time shows that there are multiple metabolites that differ between the times, so when analyzing plasma metabolome we will keep Time as a separate factor.

```{r}
# create a column for the different days

plasmaaq <- aq %>% 
  filter(!Label == "tumor") %>% 
  mutate(Time = factor(case_when(
    Label %in% "plasmaD7" ~ "7",
    Label %in% "plasmaD21" ~ "21",
    Label %in% "plasmaD35" ~ "35"
  ), ordered = TRUE, levels = c("7", "21", "35")))

# are there differences between time points?
plasmetab <- unique(plasmaaq$metabolite)
pvals <- data.frame()

for(i in 1:length(plasmetab)) {
  mod <- aov(area ~ Time, data = filter(plasmaaq, metabolite == plasmetab[i]))
  pvals[i, "metabolite"] <- plasmetab[i]
  pvals[i, "pval"] <- round(summary(mod)[[1]][["Pr(>F)"]][1], 4)
}

# pull significant p values into a table
sigs <- pvals[pvals$pval < 0.05,]
knitr::kable(sigs)
```

To visualize the results, we can use a Tukey pos-hoc test.
```{r}
sigdf <- plasmaaq[plasmaaq$metabolite %in% sigs$metabolite, ]

# perform ANOVA again and store Tukey variables
Tmetabs <- unique(sigdf$metabolite)
tukeyOut <- data.frame()

for(i in 1:length(Tmetabs)) {
  # re-run the ANOVA
  mod <- aov(area ~ Time, data = filter(sigdf, metabolite == Tmetabs[i]))
  # perform Tukey post-hoc test and store significant p values
  tuk <- TukeyHSD(mod)
  tukmat <- tuk$Time
  sig <- data.frame(p = round(tukmat[,"p adj"], 4),
                    contrast = dimnames(tukmat)[[1]])
  
  
  ## workaround for if Tukey does not show significance but ANOVA does:
  if(any(sig$p < 0.05)) {
    
    sigsdf <- sig[sig$p < 0.05, ] 
    sigsdf$metabolite <- Tmetabs[i]
  } else {
    
    sigsdf <- data.frame(p = "error",
                         contrast = "error",
                         metabolite = Tmetabs[i])
    
  }
  
  
  # append to outDF
  tukeyOut <- rbind(tukeyOut, sigsdf)
}



rownames(tukeyOut) <- NULL
tukeyOut <- tukeyOut[!tukeyOut$p %in% "error",]

knitr::kable(tukeyOut)
```
Another visualization tool is boxplots.
```{r}
## make boxplots to illustrate differences

tukdf <- plasmaaq[plasmaaq$metabolite %in% tukeyOut$metabolite, ]

ggplot(data = tukdf, aes(x = Time, y = area)) +
  geom_boxplot() +
  facet_wrap(~metabolite) 
```



## Individual Metabolites 

#### Four treatment groups

The initial analyis is comparing all four treatment groups to each other in the 2x2 factorial style. The code follows this structure for pairwise comparisons with ANOVA:

>This code is a one-way ANOVA between the area under the curve (dependent variable) and the four treatment groups (independent variable) for the tumor tissue only. This ANOVA repeats in a "for loop" for all 136 aqueous metabolites, and stores the p values in a table. 

##### Tumor tissue 
There are four significant metabolites; that is, four metabolites vary significantly between the four treatment groups in the tumor tissue. 

```{r collapse = TRUE}
### TUMOR

# make separate dataframe for the tumor tissue
tumor <- filter(aq, Label == "tumor")
metabs <- levels(tumor$metabolite)

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod <- aov(area ~ treatmentID, data = filter(tumor, metabolite == metabs[i]))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pval"] <- round(summary(mod)[[1]][["Pr(>F)"]][1], 4)
   
}

# pull significant p values into a table
sigs <- pvals[pvals$pval < 0.05,]
knitr::kable(sigs, col.names =  c("metabolite", "p value"))

```

To visualize the results, we can use a Tukey pos-hoc test.
```{r}
sigdf <- tumor[tumor$metabolite %in% sigs$metabolite, ]

# perform ANOVA again and store Tukey variables
Tmetabs <- unique(sigdf$metabolite)
tukeyOut <- data.frame()

for(i in 1:length(Tmetabs)) {
  # re-run the ANOVA
  mod <- aov(area ~ treatmentID, data = filter(sigdf, metabolite == Tmetabs[i]))
  # perform Tukey post-hoc test and store significant p values
  tuk <- TukeyHSD(mod)
  tukmat <- tuk$treatmentID
  sig <- data.frame(p = round(tukmat[,"p adj"], 4),
                    contrast = dimnames(tukmat)[[1]])
  
  
  ## workaround for if Tukey does not show significance but ANOVA does:
  if(any(sig$p < 0.05)) {
    
    sigsdf <- sig[sig$p < 0.05, ] 
    sigsdf$metabolite <- Tmetabs[i]
  } else {
    
    sigsdf <- data.frame(p = "error",
                         contrast = "error",
                         metabolite = Tmetabs[i])
    
  }
  
  
  # append to outDF
  tukeyOut <- rbind(tukeyOut, sigsdf)
}



rownames(tukeyOut) <- NULL
tukeyOut <- tukeyOut[!tukeyOut$p %in% "error",]

knitr::kable(tukeyOut)
```
Another visualization tool is boxplots.
```{r}
## make boxplots to illustrate differences

tukdf <- tumor[tumor$metabolite %in% tukeyOut$metabolite, ]

ggplot(data = tukdf, aes(x = treatmentID, y = area)) +
  geom_boxplot() +
  facet_wrap(~metabolite) 
```
##### Plasma


Since we clearly saw that there is a difference in the plasma aqueous metabolites between days (above), we will keep Time as a separate factor moving forward.
Three separate ANOVAs; one for each time point.
```{r}

# get metabolites
# df - plasmaaq
# list of metabolites - plasmetab

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod1 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "7"))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pvalD7"] <- round(summary(mod1)[[1]][["Pr(>F)"]][1], 4)
  mod2 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "21"))
  pvals[i, "pvalD21"] <- round(summary(mod2)[[1]][["Pr(>F)"]][1], 4)
  mod3 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "35"))
  pvals[i, "pvalD35"] <- round(summary(mod3)[[1]][["Pr(>F)"]][1], 4)
  
}

sigs <- pvals[pvals[,2:4] < 0.05, ] %>% na.omit()

```

```{r}


sigdf <- plasmaaq[plasmaaq$metabolite %in% sigs$metabolite, ]

# perform ANOVA again and store Tukey variables
Tmetabs <- unique(sigdf$metabolite)
tukeyOut <- data.frame()

for(i in 1:length(Tmetabs)) {
  # re-run the ANOVA
  mod1 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "7"))
  tuk1 <- TukeyHSD(mod1)$treatmentID 
  tuk1 <- cbind(tuk1, Time = 7)
  mod2 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "21"))
  tuk2 <- TukeyHSD(mod2)$treatmentID
  tuk2 <- cbind(tuk2, Time = 21)
  mod3 <- aov(area~ treatmentID, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "35"))
  tuk3 <- TukeyHSD(mod3)$treatmentID
  tuk3 <- cbind(tuk3, Time = 35)
  
  # perform Tukey post-hoc test and store significant p values
  
  tukmat <- rbind(tuk1, tuk2, tuk3)
  sig <- data.frame(p = round(tukmat[,"p adj"], 4),
                    contrast = dimnames(tukmat)[[1]],
                    metabolite = as.character(Tmetabs[i]),
                    time = tukmat[,"Time"])
  tukeyOut <- rbind(sig, tukeyOut)
  
}

knitr::kable(tukeyOut)
```

```{r}

## make boxplots to illustrate differences

tukdf <- plasmaaq[plasmaaq$metabolite %in% tukeyOut$metabolite, ]

ggplot(data = tukdf, aes(x = treatmentID, y = area)) +
  geom_boxplot() +
  facet_wrap(Time~metabolite) 
```


#### Exercise vs. Sedentary

Two exercise groups: exercised and exercise-restricted (sedentary).

##### Tumor

There is one significant metabolite: Quinolinate.
```{r collapse = TRUE}
### TUMOR

# make separate dataframe for the tumor tissue
# df - tumor
# metabolite list - metabs

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod <- aov(area ~ Exercise, data = filter(tumor, metabolite == metabs[i]))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pval"] <- round(summary(mod)[[1]][["Pr(>F)"]][1], 4)
   
}

# pull significant p values into a table
sigs <- pvals[pvals$pval < 0.05,]
knitr::kable(sigs, col.names =  c("metabolite", "p value"))

```


Since there are only two levels, this is basically a t-test and we do not need a Tukey's post hoc. 
```{r}
## make boxplots to illustrate differences

tukdf <- tumor[tumor$metabolite %in% sigs$metabolite, ]

ggplot(data = tukdf, aes(x = Exercise, y = area)) +
  geom_boxplot() +
  facet_wrap(~metabolite) 
```
##### Plasma

```{r}

# get metabolites

# list of metabolites - plasmetab

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod1 <- aov(area~ Exercise, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "7"))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pvalD7"] <- round(summary(mod1)[[1]][["Pr(>F)"]][1], 4)
  mod2 <- aov(area~ Exercise, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "21"))
  pvals[i, "pvalD21"] <- round(summary(mod2)[[1]][["Pr(>F)"]][1], 4)
  mod3 <- aov(area~ Exercise, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "35"))
  pvals[i, "pvalD35"] <- round(summary(mod3)[[1]][["Pr(>F)"]][1], 4)
  
}

sigs <- pvals[pvals[,2:4] < 0.05, ] %>% na.omit()
knitr::kable(sigs, col.names =  c("metabolite", "p value D7", "p value D21", "p value D35"))

```

```{r}
## make boxplots to illustrate differences

tukdf <- plasmaaq[plasmaaq$metabolite %in% sigs$metabolite, ]

ggplot(data = tukdf, aes(x = Exercise, y = area)) +
  geom_boxplot() +
  facet_wrap(Time~metabolite) 

```

#### Weight Restricted vs Ad-lib Fed

Two weight groups: energy restricted and ad libitum fed

##### Tumor


```{r collapse = TRUE}
### TUMOR

# make separate dataframe for the tumor tissue
# df - tumor
# metabolite list - metabs

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod <- aov(area ~ Weight, data = filter(tumor, metabolite == metabs[i]))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pval"] <- round(summary(mod)[[1]][["Pr(>F)"]][1], 4)
   
}

# pull significant p values into a table
sigs <- pvals[pvals$pval < 0.05,]
knitr::kable(sigs, col.names =  c("metabolite", "p value"))

```

Since there are only two levels, this is basically a t-test and we do not need a Tukey's post hoc. 
```{r}
## make boxplots to illustrate differences

tukdf <- tumor[tumor$metabolite %in% sigs$metabolite, ]

ggplot(data = tukdf, aes(x = Weight, y = area)) +
  geom_boxplot() +
  facet_wrap(~metabolite) 
```
##### Plasma

```{r}

# get metabolites

# list of metabolites - plasmetab

pvals <- data.frame()

# run the for loop
for(i in 1:length(metabs)) {
  mod1 <- aov(area~ Weight, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "7"))
  pvals[i, "metabolite"] <- metabs[i]
  pvals[i, "pvalD7"] <- round(summary(mod1)[[1]][["Pr(>F)"]][1], 4)
  mod2 <- aov(area~ Weight, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "21"))
  pvals[i, "pvalD21"] <- round(summary(mod2)[[1]][["Pr(>F)"]][1], 4)
  mod3 <- aov(area~ Weight, data = filter(plasmaaq, metabolite == plasmetab[i] & Time == "35"))
  pvals[i, "pvalD35"] <- round(summary(mod3)[[1]][["Pr(>F)"]][1], 4)
  
}

sigs <- pvals[pvals[,2:4] < 0.05, ] %>% na.omit()
knitr::kable(sigs, col.names =  c("metabolite", "p value D7", "p value D21", "p value D35"))

```

```{r}
## make boxplots to illustrate differences

tukdf <- plasmaaq[plasmaaq$metabolite %in% sigs$metabolite, ]

ggplot(data = tukdf, aes(x = Weight, y = area)) +
  geom_boxplot() +
  facet_wrap(Time~metabolite) 
```

